#!/usr/bin/python
# encoding=UTF-8

# Copyright Â© 2010-2015 Jakub Wilk <jwilk@jwilk.net>

# Redistribution and use in source and compiled forms, with or without
# modification, are permitted under any circumstances. No warranty.

from __future__ import print_function

import argparse
import sys

from mutagen.id3 import ID3

ap = argparse.ArgumentParser(description='change encoding of ID3v2 tags to UCS-2')
ap.add_argument('files', nargs='+', metavar='<filename>')
options = ap.parse_args()

for filename in options.files:
    mp3 = ID3(filename)
    dirty = False
    for key, value in mp3.iteritems():
        if value.encoding == 0:
            continue
        text = unicode(value)
        try:
            text = text.decode('ASCII')
            encoding = 0
        except (UnicodeDecodeError, UnicodeEncodeError):
            encoding = 1
        value = type(value)(encoding=encoding, text=text)
        mp3[key] = value
        dirty = True
    if dirty:
        print('Writing {path}'.format(path=filename), file=sys.stderr)
        mp3.save()
    else:
        print('Skipping {path}'.format(path=filename), file=sys.stderr)

# vim:ts=4 sts=4 sw=4 et
